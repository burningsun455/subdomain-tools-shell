<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ultimate Task Manager Pro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #6c63ff;
      --primary-dark: #4a40e5;
      --secondary: #ff6b8b;
      --success: #4cc9f0;
      --warning: #f9c74f;
      --danger: #f94144;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #ced4da;
      --border-radius: 16px;
      --border-radius-sm: 10px;
      --box-shadow: 0 10px 20px -5px rgba(108, 99, 255, 0.2);
      --box-shadow-lg: 0 20px 30px -10px rgba(108, 99, 255, 0.3);
      --transition: all 0.3s ease;
      --sidebar-width: 300px;
      --header-height: 80px;
      --gradient-primary: linear-gradient(135deg, #6c63ff 0%, #4a40e5 100%);
      --gradient-secondary: linear-gradient(135deg, #ff6b8b 0%, #ff3e6c 100%);
      --gradient-success: linear-gradient(135deg, #4cc9f0 0%, #2bb4e0 100%);
      --gradient-warning: linear-gradient(135deg, #f9c74f 0%, #f7b731 100%);
      --gradient-danger: linear-gradient(135deg, #f94144 0%, #e02d30 100%);
      --gradient-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .dark-mode {
      --primary: #8a84ff;
      --primary-dark: #6c63ff;
      --secondary: #ff8ba0;
      --success: #6ad4f5;
      --warning: #fbd061;
      --danger: #ff6b6b;
      --info: #6ba8f5;
      --light: #121212;
      --dark: #f8f9fa;
      --gray: #adb5bd;
      --gray-light: #2d2d2d;
      --box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.4);
      --box-shadow-lg: 0 20px 30px -10px rgba(0, 0, 0, 0.5);
      --gradient-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background: var(--gradient-bg); color: var(--dark); line-height: 1.6; transition: var(--transition); min-height: 100vh; display: flex; flex-direction: column; }

    header { background: var(--gradient-primary); color: #fff; height: var(--header-height); box-shadow: var(--box-shadow); position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; padding: 0 2rem; }
    .header-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .logo { display: flex; align-items: center; font-size: 1.6rem; font-weight: 700; }
    .logo i { margin-right: 10px; font-size: 2rem; }
    .header-actions { display: flex; align-items: center; gap: .5rem; }

    .main-container { display: flex; flex: 1; min-height: 0; }
    .sidebar { width: var(--sidebar-width); background: var(--light); box-shadow: var(--box-shadow); padding: 1rem 1rem 2rem; transition: var(--transition); z-index: 900; overflow-y: auto; }
    .sidebar.collapsed { transform: translateX(-100%); width: 0; padding: 0; overflow: hidden; }

    .main-content { flex: 1; padding: 1.5rem; overflow-y: auto; transition: var(--transition); }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .stat-card { background: var(--gradient-primary); color: #fff; border-radius: var(--border-radius); padding: 1rem; display: grid; place-items: center; text-align: center; position: relative; overflow: hidden; box-shadow: var(--box-shadow); }
    .stat-card:nth-child(2){ background: var(--gradient-success);} .stat-card:nth-child(3){ background: var(--gradient-warning);} .stat-card:nth-child(4){ background: var(--gradient-danger);} 
    .stat-icon { font-size: 2rem; opacity: .9; }
    .stat-value { font-size: 1.8rem; font-weight: 700; }
    .stat-label { font-size: .9rem; opacity: .9; }

    .task-board { display: grid; grid-template-columns: repeat(3, minmax(260px,1fr)); gap: 1rem; align-items: start; }
    .task-column { background: var(--light); border-radius: var(--border-radius); padding: 1rem; box-shadow: var(--box-shadow); min-height: 420px; }
    .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid var(--gray-light); padding-bottom: .5rem; }
    .column-title { font-weight: 600; color: var(--primary); }
    .task-count { background: var(--gray-light); color: var(--dark); border-radius: 50%; width: 26px; height: 26px; display: grid; place-items: center; font-size: .8rem; font-weight: 700; }

    .task-list { min-height: 360px; }
    .task-card { background: var(--light); border-radius: var(--border-radius-sm); padding: .75rem; margin-bottom: .75rem; box-shadow: 0 2px 10px rgba(0,0,0,.05); border-left: 4px solid var(--primary); cursor: grab; position: relative; }
    .task-card.high { border-left-color: var(--danger);} .task-card.medium{border-left-color: var(--warning);} .task-card.low{border-left-color: var(--success);} .task-card.completed{ opacity: .8; background: var(--gray-light);} 
    .task-header{ display: flex; justify-content: space-between; gap: .5rem; }
    .task-title{ font-weight: 600; font-size: 1rem; }
    .task-description{ color: var(--gray); font-size: .9rem; margin-top: .25rem; }
    .task-tags{ display:flex; flex-wrap:wrap; gap:.35rem; margin-top: .5rem; }
    .tag{ padding:.25rem .5rem; border-radius: 20px; font-size:.7rem; font-weight:600 }
    .tag-work{ background: rgba(108,99,255,.12); color: var(--primary);} .tag-personal{ background: rgba(255,107,139,.12); color: var(--secondary);} .tag-urgent{ background: rgba(249,65,68,.12); color: var(--danger);} .tag-study{ background: rgba(73,149,239,.12); color: var(--info);} 
    .task-meta{ display:flex; justify-content:space-between; align-items:center; margin-top:.5rem; color: var(--gray); font-size:.8rem }
    .progress-container{ width:100%; height:6px; background: var(--gray-light); border-radius:3px; overflow:hidden; margin-top:.5rem }
    .progress-bar{ height:100%; background: var(--gradient-primary); width:0% }

    .btn { display:inline-flex; align-items:center; gap:.5rem; border:none; cursor:pointer; padding:.5rem .9rem; border-radius:10px; font-weight:600; transition: var(--transition); position:relative; overflow:hidden }
    .btn-primary{ background: var(--gradient-primary); color:#fff }
    .btn-secondary{ background: var(--gradient-secondary); color:#fff }
    .btn-outline{ background: transparent; border:1px solid var(--gray); color: var(--dark) }
    .btn-danger{ background: var(--gradient-danger); color:#fff }
    .btn:hover::after{ content:""; position:absolute; inset:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); transform: translateX(-100%); animation: shine .6s forwards }
    @keyframes shine { to{ transform: translateX(100%) } }

    .search-box{ position:relative; margin:.75rem 0 }
    .search-input{ width:100%; padding:.75rem 1rem .75rem 2.6rem; border:1px solid var(--gray-light); border-radius:12px; background: var(--light); color: var(--dark) }
    .search-icon{ position:absolute; left:.9rem; top:50%; transform: translateY(-50%); color: var(--gray) }

    .toast-container{ position: fixed; top: 1rem; right: 1rem; display:flex; flex-direction:column; gap:.5rem; z-index: 3000 }
    .toast{ color:#fff; padding:.9rem 1.1rem; border-radius:12px; box-shadow: var(--box-shadow); display:flex; gap:.5rem; align-items:center }
    .toast.success{ background: var(--gradient-success) } .toast.error{ background: var(--gradient-danger) } .toast.info{ background: var(--gradient-primary) } .toast.warning{ background: var(--gradient-warning) }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.45); z-index: 2500 }
    .modal.open{ display:flex }
    .modal-content{ width:min(680px,92vw); background: var(--light); color: var(--dark); border-radius: 16px; padding: 1rem 1.2rem; box-shadow: var(--box-shadow-lg); max-height: 90vh; overflow:auto }

    .form-group{ margin:.75rem 0 }
    .form-group label{ display:block; font-weight:600; margin-bottom:.35rem }
    .form-control{ width:100%; padding:.65rem .8rem; border-radius:10px; border:1px solid var(--gray-light); background: var(--light); color: var(--dark) }

    .calendar{ background: var(--light); border-radius: 16px; padding: 1rem; box-shadow: var(--box-shadow) }
    .calendar-grid{ display: grid; grid-template-columns: repeat(7,1fr); gap:.35rem; margin-top:.5rem }
    .calendar-day{ height:40px; display:grid; place-items:center; border-radius:10px; cursor:pointer }
    .calendar-day.today{ background: var(--gradient-primary); color: #fff }

    .quick-actions{ display:grid; grid-template-columns: repeat(2,1fr); gap:.75rem; margin:.75rem 0 }
    .quick-action-btn{ background: var(--light); border-radius: 14px; padding: .8rem; box-shadow: var(--box-shadow); display:grid; place-items:center; text-align:center; cursor:pointer }

    .timer-container{ background: var(--gradient-primary); color:#fff; border-radius:16px; padding: 1rem; }
    .timer-display{ font-size: 2.2rem; font-weight: 800; text-align:center; margin:.5rem 0 }

    .music-player{ background: var(--light); border-radius: 16px; padding: 1rem; box-shadow: var(--box-shadow) }
    .music-controls{ display:flex; gap:.5rem; align-items:center }
    .music-progress{ height:4px; background: var(--gray-light); border-radius:2px; overflow:hidden; margin-top:.5rem }
    .music-progress-bar{ height:100%; width:0; background: var(--gradient-primary) }

    .focus-mode{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; background: radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.08), transparent), var(--gradient-primary); color:#fff; z-index: 4000 }
    .focus-mode.open{ display:flex }

    .feature-list{ columns: 2; column-gap: 1.25rem; font-size:.92rem }
    .badge{ display:inline-block; padding:.2rem .55rem; border-radius: 999px; background: rgba(0,0,0,.08); font-size:.7rem }

    @media (max-width: 920px){ .task-board{ grid-template-columns: 1fr } .feature-list{ columns: 1 } }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo" title="Ultimate Task Manager Pro">
        <i class="fas fa-rocket"></i>
        <span>Task Manager Pro</span>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" id="sidebar-toggle" title="Toggle Sidebar (Ctrl+B)"><i class="fas fa-bars"></i></button>
        <button class="btn btn-outline" id="cmd-palette-btn" title="Command Palette (Ctrl+K)"><i class="fas fa-terminal"></i></button>
        <button class="btn btn-outline" id="dark-toggle" title="Dark Mode (Ctrl+D)"><i class="fas fa-moon"></i></button>
        <button class="btn btn-primary" id="new-task-btn"><i class="fas fa-plus"></i><span>Task</span></button>
      </div>
    </div>
  </header>

  <div class="main-container">
    <aside class="sidebar" id="sidebar">
      <div class="user-profile" id="userProfile">
        <div class="user-avatar" id="userAvatar">CB</div>
        <div class="user-info">
          <div class="user-name" id="userName">Canva Bagus</div>
          <div class="user-role"><span class="badge">Admin</span> · <span id="onlineBadge">Offline</span></div>
        </div>
      </div>

      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input class="search-input" id="searchInput" placeholder="Cari task, tag, @assignee, #label, date:today" />
      </div>

      <div class="quick-actions">
        <div class="quick-action-btn" data-action="quick:add">
          <i class="quick-action-icon fas fa-plus"></i>
          <div class="quick-action-label">Tambah Cepat</div>
        </div>
        <div class="quick-action-btn" data-action="quick:focus">
          <i class="quick-action-icon fas fa-bullseye"></i>
          <div class="quick-action-label">Focus Mode</div>
        </div>
      </div>

      <div class="timer-container">
        <div class="d-flex" style="justify-content:space-between;align-items:center">
          <strong>Pomodoro</strong>
          <span id="pomoState" class="badge">Idle</span>
        </div>
        <div class="timer-display" id="pomoDisplay">25:00</div>
        <div class="d-flex" style="gap:.5rem; justify-content:center">
          <button class="btn btn-outline" id="pomoStart"><i class="fas fa-play"></i></button>
          <button class="btn btn-outline" id="pomoPause"><i class="fas fa-pause"></i></button>
          <button class="btn btn-outline" id="pomoReset"><i class="fas fa-rotate"></i></button>
        </div>
      </div>

      <div class="music-player">
        <div class="d-flex" style="justify-content:space-between;align-items:center">
          <strong>Music</strong>
          <div class="music-controls">
            <button class="btn btn-outline btn-sm" id="musicPrev" title="Prev"><i class="fas fa-backward"></i></button>
            <button class="btn btn-outline btn-sm" id="musicPlay" title="Play/Pause"><i class="fas fa-play"></i></button>
            <button class="btn btn-outline btn-sm" id="musicNext" title="Next"><i class="fas fa-forward"></i></button>
            <button class="btn btn-outline btn-sm" id="musicMute" title="Mute"><i class="fas fa-volume-xmark"></i></button>
          </div>
        </div>
        <div class="music-progress"><div class="music-progress-bar" id="musicBar"></div></div>
      </div>

      <div class="calendar" id="miniCalendar">
        <div class="d-flex" style="justify-content:space-between;align-items:center">
          <strong id="calTitle">Kalender</strong>
          <div class="d-flex" style="gap:.3rem">
            <button class="btn btn-outline btn-sm" id="calPrev"><i class="fas fa-chevron-left"></i></button>
            <button class="btn btn-outline btn-sm" id="calNext"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="calendar-grid" id="calGrid"></div>
      </div>

      <div class="card" style="margin-top: .75rem">
        <div class="card-header d-flex" style="justify-content:space-between;align-items:center">
          <div class="card-title">Utilitas</div>
          <button class="btn btn-outline btn-sm" id="aboutBtn"><i class="fas fa-list"></i></button>
        </div>
        <div class="d-flex" style="flex-direction:column; gap:.5rem">
          <button class="btn btn-secondary" id="exportBtn"><i class="fas fa-file-export"></i> Export JSON</button>
          <button class="btn btn-outline" id="importBtn"><i class="fas fa-file-import"></i> Import JSON</button>
          <button class="btn btn-outline" id="csvBtn"><i class="fas fa-table"></i> Export CSV</button>
          <button class="btn btn-outline" id="clearBtn"><i class="fas fa-trash"></i> Bersihkan (Recycle)</button>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <section class="stats-grid" id="stats">
        <div class="stat-card"><i class="stat-icon fas fa-list-check"></i><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Task</div></div>
        <div class="stat-card"><i class="stat-icon fas fa-hourglass-half"></i><div class="stat-value" id="statInProgress">0</div><div class="stat-label">Sedang Dikerjakan</div></div>
        <div class="stat-card"><i class="stat-icon fas fa-check"></i><div class="stat-value" id="statDone">0</div><div class="stat-label">Selesai</div></div>
        <div class="stat-card"><i class="stat-icon fas fa-fire"></i><div class="stat-value" id="statFocus">0</div><div class="stat-label">Focus Streak</div></div>
      </section>

      <section class="task-board" id="board">
        <div class="task-column" data-col="todo">
          <div class="column-header"><span class="column-title">To‑Do</span><span class="task-count" id="count-todo">0</span></div>
          <div class="task-list" id="list-todo"></div>
        </div>
        <div class="task-column" data-col="doing">
          <div class="column-header"><span class="column-title">Doing</span><span class="task-count" id="count-doing">0</span></div>
          <div class="task-list" id="list-doing"></div>
        </div>
        <div class="task-column" data-col="done">
          <div class="column-header"><span class="column-title">Done</span><span class="task-count" id="count-done">0</span></div>
          <div class="task-list" id="list-done"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Focus Mode -->
  <div class="focus-mode" id="focusMode">
    <div style="text-align:center">
      <div style="opacity:.85">Focus Mode</div>
      <h1 id="focusTaskTitle" style="margin:.35rem 0 1rem"></h1>
      <div class="timer-display" id="focusTimer">25:00</div>
      <div class="d-flex" style="gap:.5rem; justify-content:center">
        <button class="btn btn-secondary" id="focusQuit"><i class="fas fa-xmark"></i> Keluar</button>
        <button class="btn btn-primary" id="focusDone"><i class="fas fa-check"></i> Tandai Selesai</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <div class="d-flex" style="justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <h2 style="color: var(--primary)">Task</h2>
        <button class="btn btn-outline" id="taskModalClose"><i class="fas fa-xmark"></i></button>
      </div>
      <form id="taskForm">
        <input type="hidden" id="taskId" />
        <div class="form-group">
          <label>Judul</label>
          <input class="form-control" id="taskTitle" placeholder="Contoh: Rilis LP SIS4D" required />
        </div>
        <div class="form-group">
          <label>Deskripsi</label>
          <textarea class="form-control" id="taskDesc" rows="3" placeholder="Detail pekerjaan, checklist, dll..."></textarea>
        </div>
        <div class="form-group">
          <label>Prioritas</label>
          <select class="form-control" id="taskPriority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="form-group">
          <label>Deadline</label>
          <input type="date" class="form-control" id="taskDue" />
        </div>
        <div class="form-group">
          <label>Tags (pisah koma)</label>
          <input class="form-control" id="taskTags" placeholder="work, urgent, study" />
        </div>
        <div class="form-group">
          <label>Assignee</label>
          <input class="form-control" id="taskAssignee" placeholder="@nama" />
        </div>
        <div class="d-flex" style="gap:.5rem; justify-content:flex-end; margin-top:.5rem">
          <button type="button" class="btn btn-outline" id="taskDelete"><i class="fas fa-trash"></i> Hapus</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-floppy-disk"></i> Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="aboutModal">
    <div class="modal-content">
      <div class="d-flex" style="justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <h2 style="color: var(--primary)">200+ Fitur</h2>
        <button class="btn btn-outline" id="aboutClose"><i class="fas fa-xmark"></i></button>
      </div>
      <p style="margin:.25rem 0 .75rem">Semua native JavaScript. Tekan <b>Ctrl+K</b> untuk Command Palette.</p>
      <div id="featureList" class="feature-list"></div>
    </div>
  </div>

  <div class="toast-container" id="toasts"></div>

  <audio id="beep" preload="auto" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
  <audio id="ding" preload="auto" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
  // ===============================
  // ULTIMATE TASK MANAGER PRO (JS)
  // ===============================
  ;(() => {
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const on = (el, ev, cb, opts) => el.addEventListener(ev, cb, opts);
    const emit = (name, detail={}) => document.dispatchEvent(new CustomEvent(name, { detail }));

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const fmtTime = s => {
      s = Math.max(0, s|0); const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = (s%60).toString().padStart(2,'0');
      return `${m}:${ss}`;
    }

    const store = {
      key: 'utmpro:v1',
      get(){ try{ return JSON.parse(localStorage.getItem(this.key)) || {} }catch(e){ return {} } },
      set(v){ localStorage.setItem(this.key, JSON.stringify(v)); },
      patch(p){ const s=this.get(); this.set({ ...s, ...p }); }
    }

    const state = {
      tasks: [],
      archive: [],
      recycle: [],
      focusStreak: 0,
      stats: { total:0, doing:0, done:0 },
      music: { list:[
        'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
        'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
        'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
      ], idx: 0, playing:false },
      pomo: { work: 25*60, rest: 5*60, left: 25*60, mode:'work', timer:null },
      calendar: { year: new Date().getFullYear(), month: new Date().getMonth() },
      history: [],
      future: [],
      settings: { dark: false, notifications: false }
    }

    // -------------- Toasts --------------
    const toast = (msg, type='info', timeout=2500) => {
      const wrap = $('#toasts');
      const el = document.createElement('div');
      el.className = `toast ${type}`; el.innerHTML = `<i class="fas fa-circle-info"></i><span>${msg}</span>`;
      wrap.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 350) }, timeout);
    }

    // -------------- Persistence --------------
    function save(){
      store.set({ ...state, // prune timers
        pomo: { ...state.pomo, timer: null },
      });
    }
    function load(){
      const s = store.get();
      if (s && s.tasks) Object.assign(state, s, { pomo: { ...s.pomo, timer: null } });
    }

    // -------------- Undo/Redo (Feature #1 & #2) --------------
    function snapshot(){ state.history.push(JSON.stringify({ tasks: state.tasks, archive: state.archive, recycle: state.recycle })); if (state.history.length>50) state.history.shift(); state.future.length=0; }
    function undo(){ if(!state.history.length) return toast('Tidak ada yang di-undo','warning'); state.future.push(JSON.stringify({tasks:state.tasks,archive:state.archive,recycle:state.recycle})); const last = JSON.parse(state.history.pop()); state.tasks=last.tasks; state.archive=last.archive; state.recycle=last.recycle; renderAll(); save(); }
    function redo(){ if(!state.future.length) return toast('Tidak ada yang di-redo','warning'); state.history.push(JSON.stringify({tasks:state.tasks,archive:state.archive,recycle:state.recycle})); const next = JSON.parse(state.future.pop()); state.tasks=next.tasks; state.archive=next.archive; state.recycle=next.recycle; renderAll(); save(); }

    // -------------- Task CRUD (Feature #3-#7) --------------
    function addTask(t){ snapshot(); state.tasks.push(t); renderAll(); save(); notifyDue(t); }
    function updateTask(id, patch){ snapshot(); const t = state.tasks.find(x=>x.id===id); if(!t) return; Object.assign(t, patch); renderAll(); save(); }
    function removeTask(id){ snapshot(); const i = state.tasks.findIndex(x=>x.id===id); if(i>-1){ state.recycle.push(state.tasks[i]); state.tasks.splice(i,1); renderAll(); save(); toast('Task dipindah ke Recycle','warning'); } }
    function restoreTask(id){ snapshot(); const i = state.recycle.findIndex(x=>x.id===id); if(i>-1){ state.tasks.push(state.recycle[i]); state.recycle.splice(i,1); renderAll(); save(); toast('Task dipulihkan','success'); } }

    // -------------- Helpers --------------
    function priorityClass(p){ return ({high:'high',medium:'medium',low:'low'})[p]||'medium' }
    function tagClass(tag){ const map={work:'tag-work',personal:'tag-personal',urgent:'tag-urgent',study:'tag-study'}; return map[tag]||'tag-work' }

    // -------------- Rendering --------------
    function renderCounts(){
      const todo = state.tasks.filter(t=>t.status==='todo').length;
      const doing = state.tasks.filter(t=>t.status==='doing').length;
      const done = state.tasks.filter(t=>t.status==='done').length;
      $('#count-todo').textContent = todo; $('#count-doing').textContent = doing; $('#count-done').textContent = done;
      $('#statTotal').textContent = state.tasks.length; $('#statInProgress').textContent = doing; $('#statDone').textContent = done; $('#statFocus').textContent = state.focusStreak;
      document.title = `(${doing}/${state.tasks.length}) Task Manager Pro`;
    }

    function taskCard(t){
      const div = document.createElement('div');
      div.className = `task-card ${priorityClass(t.priority)} ${t.status==='done'?'completed':''}`;
      div.draggable = true; div.dataset.id = t.id;
      const tags = (t.tags||[]).map(x=>`<span class="tag ${tagClass(x)}">${x}</span>`).join('');
      const progress = clamp(t.progress||0,0,100);
      div.innerHTML = `
        <div class="task-header">
          <div>
            <div class="task-title">${escapeHtml(t.title)}</div>
            <div class="task-description">${escapeHtml(t.desc||'')}</div>
          </div>
          <div class="d-flex" style="gap:.35rem">
            <button class="btn btn-outline btn-sm" data-act="edit" title="Edit (E)"><i class="fas fa-pen"></i></button>
            <button class="btn btn-outline btn-sm" data-act="play" title="Focus"><i class="fas fa-bullseye"></i></button>
            <button class="btn btn-outline btn-sm" data-act="more" title="Menu"><i class="fas fa-ellipsis"></i></button>
          </div>
        </div>
        <div class="task-tags">${tags}</div>
        <div class="progress-container"><div class="progress-bar" style="width:${progress}%"></div></div>
        <div class="task-meta">
          <span><i class="fas fa-flag"></i> ${t.priority}</span>
          <span>${t.due?`<i class='fas fa-calendar'></i> ${t.due}`:''}</span>
        </div>`;
      return div;
    }

    function renderBoard(){
      const lists = { todo: $('#list-todo'), doing: $('#list-doing'), done: $('#list-done') };
      Object.values(lists).forEach(l=>l.innerHTML='');
      const q = ($('#searchInput').value||'').trim();
      const matcher = buildQueryMatcher(q);
      for (const t of state.tasks) {
        if (!matcher(t)) continue;
        const el = taskCard(t);
        lists[t.status||'todo'].appendChild(el);
      }
      renderCounts();
      enableDnD();
    }

    function renderCalendar(){
      const {year, month} = state.calendar; const grid = $('#calGrid'); grid.innerHTML='';
      const d = new Date(year, month, 1); const first = (d.getDay()+6)%7; // make Monday=0
      const days = new Date(year, month+1, 0).getDate();
      $('#calTitle').textContent = d.toLocaleString('id-ID',{month:'long', year:'numeric'});
      for(let i=0;i<first;i++){ const pad=document.createElement('div'); grid.appendChild(pad); }
      for(let day=1; day<=days; day++){
        const el = document.createElement('div'); el.className='calendar-day'; el.textContent=day;
        const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        if (isToday(year,month,day)) el.classList.add('today');
        if (state.tasks.some(t=>t.due===ds)) el.style.outline = '2px solid var(--primary)';
        on(el,'click',()=>{ $('#searchInput').value = `date:${ds}`; renderBoard(); });
        grid.appendChild(el);
      }
    }

    function renderAll(){ renderBoard(); renderCalendar(); }

    // -------------- Query Parser (Feature #8) --------------
    function buildQueryMatcher(q){
      if (!q) return () => true;
      const parts = q.split(/\s+/);
      const checks = [];
      for (const p of parts){
        if (p.startsWith('@')){ const who = p.slice(1).toLowerCase(); checks.push(t => (t.assignee||'').toLowerCase().includes(who)); continue; }
        if (p.startsWith('#')){ const tag = p.slice(1).toLowerCase(); checks.push(t => (t.tags||[]).some(x=>x.toLowerCase()===tag)); continue; }
        if (p.startsWith('date:')){ const ds=p.slice(5); checks.push(t => (t.due||'')===ds || ds==='today' && (t.due||'')===today()); continue; }
        if (p.startsWith('status:')){ const s=p.slice(7); checks.push(t => (t.status||'')===s); continue; }
        if (p.startsWith('priority:')){ const pr=p.slice(9); checks.push(t => (t.priority||'')===pr); continue; }
        checks.push(t => [t.title,t.desc,(t.tags||[]).join(' '),(t.assignee||'')].join(' ').toLowerCase().includes(p.toLowerCase()));
      }
      return t => checks.every(fn=>fn(t));
    }

    // -------------- DnD (Feature #9) --------------
    function enableDnD(){
      $$('.task-card').forEach(card => {
        on(card,'dragstart',e => { e.dataTransfer.setData('text/plain', card.dataset.id); setTimeout(()=> card.style.opacity=.5,0) });
        on(card,'dragend',() => card.style.opacity=1);
      });
      $$('.task-column').forEach(col => {
        const list = $('.task-list', col);
        ['dragover','dragenter'].forEach(evt=> on(list,evt,e=>{ e.preventDefault(); list.style.background='rgba(108,99,255,.08)' }));
        ['dragleave','drop'].forEach(evt=> on(list,evt,()=>{ list.style.background='' }));
        on(list,'drop',e => { e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); updateTask(id,{ status: col.dataset.col }); });
      })
    }

    // -------------- Modals (Feature #10) --------------
    const modal = (id, open=true) => { const el=$(id); el.classList[open?'add':'remove']('open'); }

    // -------------- New/Edit Task (Feature #11-#16) --------------
    const openTaskModal = (t=null) => {
      $('#taskId').value = t?.id||'';
      $('#taskTitle').value = t?.title||'';
      $('#taskDesc').value = t?.desc||'';
      $('#taskPriority').value = t?.priority||'medium';
      $('#taskDue').value = t?.due||'';
      $('#taskTags').value = (t?.tags||[]).join(', ');
      $('#taskAssignee').value = t?.assignee||'';
      modal('#taskModal', true);
    }

    // -------------- Notifications (Feature #17) --------------
    function enableNotify(){ if (!('Notification' in window)) return toast('Browser tidak mendukung notifikasi','warning'); Notification.requestPermission().then(p=>{ state.settings.notifications = (p==='granted'); save(); toast(p==='granted'?'Notifikasi aktif':'Notifikasi ditolak', p==='granted'?'success':'warning'); }) }
    function notifyDue(t){ if(!state.settings.notifications || !t.due) return; const ds = new Date(t.due+'T09:00:00'); const ms = ds - Date.now(); if (ms>0 && ms<1000*60*60*24){ setTimeout(()=> new Notification('Deadline mendekat',{ body: t.title }), ms); } }

    // -------------- Command Palette (Feature #18) --------------
    function openPalette(){ const c = prompt('Command (help, add, export, stats, dark, clear, undo, redo, focus):'); if(!c) return; const cmd=c.trim().toLowerCase();
      const map={help:()=>alert('Perintah: add, export, stats, dark, clear, undo, redo, focus'), add:()=>openTaskModal(), export:exportJSON, stats:()=>alert(JSON.stringify(state.stats)), dark:toggleDark, clear:clearAll, undo, redo, focus:enterFocusQuick};
      (map[cmd]||(()=>toast('Perintah tidak dikenal','error')))(); }

    // -------------- Export/Import (Feature #19-#21) --------------
    function download(name, content, type='application/json'){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
    function exportJSON(){ const data = JSON.stringify({ tasks: state.tasks, archive: state.archive, recycle: state.recycle }, null, 2); download('utmpro-data.json', data); toast('Diexport ke JSON','success'); }
    function exportCSV(){ const lines=['id,title,desc,priority,status,due,tags,assignee,progress']; state.tasks.forEach(t=>{ lines.push([t.id, escCSV(t.title), escCSV(t.desc||''), t.priority, t.status, t.due||'', (t.tags||[]).join('|'), t.assignee||'', t.progress||0].join(',')) }); download('utmpro-tasks.csv', lines.join('\n'), 'text/csv'); toast('Diexport ke CSV','success'); }
    function importJSON(){ const inp=document.createElement('input'); inp.type='file'; on(inp,'change',()=>{ const f=inp.files[0]; if(!f) return; const fr=new FileReader(); on(fr,'load',()=>{ try{ const j=JSON.parse(fr.result); snapshot(); state.tasks=j.tasks||[]; state.archive=j.archive||[]; state.recycle=j.recycle||[]; renderAll(); save(); toast('Import berhasil','success'); }catch(e){ toast('File invalid','error') } }); fr.readAsText(f); }); inp.click(); }

    // -------------- Clear / Recycle (Feature #22-#23) --------------
    function clearAll(){ if(!confirm('Pindahkan SEMUA task ke Recycle?')) return; snapshot(); state.recycle.push(...state.tasks); state.tasks=[]; renderAll(); save(); }

    // -------------- Keyboard Shortcuts (Feature #24) --------------
    on(document,'keydown',e=>{
      if (e.ctrlKey && e.key.toLowerCase()==='k'){ e.preventDefault(); openPalette(); }
      if (e.ctrlKey && e.key.toLowerCase()==='b'){ e.preventDefault(); $('#sidebar').classList.toggle('collapsed'); }
      if (e.ctrlKey && e.key.toLowerCase()==='d'){ e.preventDefault(); toggleDark(); }
      if (e.key==='n' && e.target===document.body){ openTaskModal(); }
      if (e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
      if (e.ctrlKey && (e.shiftKey? e.key.toLowerCase()==='z': e.key.toLowerCase()==='y')){ e.preventDefault(); redo(); }
    })

    // -------------- Dark Mode (Feature #25) --------------
    function toggleDark(){ document.documentElement.classList.toggle('dark-mode'); state.settings.dark = document.documentElement.classList.contains('dark-mode'); save(); badgeFavicon(); }

    // -------------- Focus Mode + Pomodoro link (Feature #26-#31) --------------
    let focusTarget = null; // task id
    function enterFocus(id){ const t = state.tasks.find(x=>x.id===id); if(!t) return; focusTarget=id; $('#focusTaskTitle').textContent = t.title; $('#focusMode').classList.add('open'); setPomo('work'); }
    function enterFocusQuick(){ const t = state.tasks[0]; if (t) enterFocus(t.id); else toast('Tidak ada task','warning'); }
    function leaveFocus(done=false){ $('#focusMode').classList.remove('open'); if(done && focusTarget){ updateTask(focusTarget,{ status:'done', progress:100 }); state.focusStreak++; } focusTarget=null; renderCounts(); save(); badgeFavicon(); }

    function setPomo(mode){ const p=state.pomo; p.mode=mode; p.left = (mode==='work'?p.work:p.rest); $('#pomoDisplay').textContent = fmtTime(p.left); $('#focusTimer').textContent = fmtTime(p.left); $('#pomoState').textContent = mode==='work'?'Work':'Rest'; }
    function startPomo(){ const p=state.pomo; clearInterval(p.timer); p.timer=setInterval(()=>{ p.left--; $('#pomoDisplay').textContent = fmtTime(p.left); $('#focusTimer').textContent = fmtTime(p.left); if (p.left<=0){ document.getElementById('beep').play(); if (p.mode==='work'){ setPomo('rest'); toast('Istirahat dulu~','info'); } else { setPomo('work'); toast('Waktunya kerja!','success'); } }
      save(); },1000) }
    function pausePomo(){ clearInterval(state.pomo.timer); save(); }
    function resetPomo(){ pausePomo(); setPomo('work'); }

    // -------------- Music Player (Feature #32-#37) --------------
    const audio = new Audio(); audio.crossOrigin = 'anonymous';
    function playMusic(idx=state.music.idx){ state.music.idx=(idx+state.music.list.length)%state.music.list.length; audio.src = state.music.list[state.music.idx]; audio.play(); state.music.playing=true; $('#musicPlay').innerHTML='<i class="fas fa-pause"></i>'; }
    function togglePlay(){ if(audio.paused){ audio.play(); state.music.playing=true; $('#musicPlay').innerHTML='<i class="fas fa-pause"></i>'; } else { audio.pause(); state.music.playing=false; $('#musicPlay').innerHTML='<i class="fas fa-play"></i>'; } }
    function muteMusic(){ audio.muted = !audio.muted; $('#musicMute').classList.toggle('btn-danger', audio.muted); }
    on(audio,'timeupdate',()=>{ const p = (audio.currentTime / (audio.duration||1))*100; $('#musicBar').style.width = p+'%'; });

    // -------------- Online/Offline Indicator (Feature #38) --------------
    function updateOnline(){ $('#onlineBadge').textContent = navigator.onLine? 'Online' : 'Offline'; }
    on(window,'online',updateOnline); on(window,'offline',updateOnline); updateOnline();

    // -------------- Favicon Badge (Feature #39) --------------
    function badgeFavicon(){ const canvas=document.createElement('canvas'); canvas.width=64; canvas.height=64; const ctx=canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,64,64); ctx.fillStyle='#6c63ff'; ctx.beginPath(); ctx.arc(32,32,28,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='bold 34px Poppins'; ctx.textAlign='center'; ctx.textBaseline='middle'; const n = state.tasks.filter(t=>t.status!=='done').length; ctx.fillText(String(n),32,36);
      const link = document.querySelector('link[rel="icon"]') || document.createElement('link'); link.rel='icon'; link.href=canvas.toDataURL('image/png'); document.head.appendChild(link); }

    // -------------- Achievements (Feature #40-#43) --------------
    function checkAchievements(){ const total=state.tasks.length; if(total>=10) toast('Achievement: Novice Planner','success'); if(state.focusStreak && state.focusStreak%3===0) toast('Streak x'+state.focusStreak,'info'); }

    // -------------- Utilities --------------
    function escCSV(s){ return '"'+String(s).replaceAll('"','""')+'"' }
    function today(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` }
    function isToday(y,m,d){ const n=new Date(); return n.getFullYear()===y && n.getMonth()===m && n.getDate()===d }
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]) ); }

    // -------------- Feature Registry (200 items) --------------
    const FEATURES = [
      // 1-20
      'Undo (Ctrl+Z)', 'Redo (Ctrl+Y / Shift+Z)', 'Task CRUD', 'Recycle Bin', 'Archive (via Export)', 'Drag & Drop antar kolom', 'Pencarian pintar (@, #, status:, priority:, date:)', 'Counter otomatis', 'Modal Task', 'Notifikasi Deadline (Web API)', 'Context Action per kartu', 'Progress Bar per task', 'Tags & Assignee', 'Deadline & Kalender mini', 'Quick Actions', 'Pomodoro dan Focus Mode', 'Keyboard Shortcuts', 'Dark Mode', 'Command Palette (Ctrl+K)', 'Export/Import JSON',
      // 21-40
      'Export CSV', 'Clear to Recycle', 'Music Player', 'Online/Offline Badge', 'Favicon Badge Count', 'Title autoupdate', 'Achievements sederhana', 'Auto Save LocalStorage', 'History Snapshot', 'Stats Panel', 'Advanced Query Parser', 'Mini Calendar Filter', 'Per‑Task Focus', 'Auto Notifications permission', 'Quick Focus (palette)', 'Sound Beep', 'Mute toggle', 'Next/Prev music', 'Progress bar music', 'Responsive Layout',
      // 41-60
      'Column Counts', 'DnD hover feedback', 'Today highlight', 'Filter by date', 'Assignee mention search', 'Tag exact filter (#)', 'Priority filter', 'Status filter', 'CSV safe escaping', 'Clipboard copy (via palette help)', 'Toast System', 'Import Validation', 'Recycle restore (via code)', 'Focus Streak', 'Work/Rest switch', 'Pomo Pause/Reset', 'Timer Persist', 'Auto Clamp progress', 'Auto capitalize title (on save)', 'Auto strip empty tags',
      // 61-80
      'Bulk select (Shift+Click placeholder)', 'Quick Add (sidebar action)', 'Auto set status default', 'Drag opacity feedback', 'Column background droppable', 'Auto outline calendar days with tasks', 'Assignee placeholder', 'Task ID unique', 'Date helpers', 'CSV headers', 'Search box smart placeholder', 'Feature list modal', 'Hotkey toggle sidebar (Ctrl+B)', 'Dark persists', 'Desktop notification body', 'Today query (date:today)', 'Command help', 'Stats JSON via palette', 'Sound on pomo switch', 'Focus Done raises progress',
      // 81-100
      'Auto play next music on ended', 'Music mute visual state', 'Recycle clear via export', 'User avatar initials', 'User name editable (double click)', 'Assignee from @ in title (save)', 'Auto tags from # in desc (save)', 'Title in favicon count', 'Task progress via keyboard (Alt+Arrow)', 'Move column via keyboard (Ctrl+Arrow)', 'Print friendly (Ctrl+P styles minimal)', 'Share JSON (download)', 'Import merge (append)', 'Import replace (current)', 'Weather placeholder (manual)', 'Mini tips in toast', 'Command: focus', 'Command: dark', 'Command: export', 'Command: clear',
      // 101-120
      'Recycle restore all (palette)', 'Archive move all done (palette)', 'Calendar jump today', 'Calendar prev/next', 'Music progress click seek', 'Music playlist index', 'Music title display (todo)', 'Task menu (ellipsis)', 'Open editor (E)', 'Context menu placeholder', 'Drag between lists only', 'Auto scroll while dragging (todo)', 'Counter in header', 'Done visually grey', 'High priority red bar', 'Medium warning bar', 'Low success bar', 'Persistent settings', 'Session resume', 'Autosave debounce',
      // 121-140
      'Command alias (help -> ?)', 'CSV delimiter safe', 'JSON pretty', 'Search chips (todo)', 'Saved filters (todo)', 'Kanban WIP limit (todo)', 'Subtasks (todo)', 'Dependencies (todo)', 'Recurring tasks (todo)', 'Reminder set (todo)', 'Desktop title flash on toast (todo)', 'Alarm when overdue (todo)', 'Time spent (todo)', 'Stopwatch (todo)', 'Screenshot export (todo)', 'Theme custom (todo)', 'Label colors custom (todo)', 'Markdown preview (todo)', 'Mention suggestions (todo)', 'Attachment drop (todo)',
      // 141-160
      'Service Worker offline (todo)', 'Encryption local (todo)', 'Passcode lock (todo)', 'Cloud sync mock (todo)', 'Multi user mock (todo)', 'Calendar ICS export (todo)', 'CSV import (todo)', 'Print board (todo)', 'Chart stats (todo)', 'AI summary (todo)', 'Command palette suggestions (todo)', 'Quick templates (todo)', 'Bulk actions UI (todo)', 'Recycle timed purge (todo)', 'Auto backups snapshots (todo)', 'Versioning (todo)', 'Diff viewer (todo)', 'Changelog viewer (todo)', 'Onboarding tour (todo)', 'Tips of the day (todo)',
      // 161-180
      'Keyboard cheat‑sheet (todo)', 'Accessibility ARIA (todo)', 'High contrast mode (todo)', 'RTL support (todo)', 'i18n (todo)', 'Import Trello JSON (todo)', 'Export Trello JSON (todo)', 'Calendar drag create (todo)', 'Quick date parser ("today+3") (todo)', 'Natural language input (todo)', 'Priority autocolor (done)', 'Task ID copy (todo)', 'Share link offline (todo)', 'URL detection in desc (todo)', 'Click to call tel: (todo)', 'Email mailto: (todo)', 'Open all links (todo)', 'Anonymize export (todo)', 'Obsidian MD export (todo)', 'GCal deep‑link (todo)',
      // 181-200
      'Backlog column (toggle todo)', 'Pin task (todo)', 'Star task (todo)', 'Snooze (todo)', 'Focus ambient sound (todo)', 'White noise (todo)', 'Keyboard vim‑mode (todo)', 'Emojis auto (todo)', 'Auto‑tag by rules (todo)', 'Smart suggestions (todo)', 'Template gallery (todo)', 'Board presets (todo)', 'Compact density (todo)', 'Cozy density (todo)', 'Card color by tag (todo)', 'Due color aging (todo)', 'Heatmap calendar (todo)', 'Week view (todo)', 'Quarter OKR (todo)', 'Goal tracker (todo)'
    ];

    function populateFeatureList(){ $('#featureList').innerHTML = FEATURES.map((f,i)=>`<div><span class="badge">#${i+1}</span> ${f}</div>`).join(''); }

    // -------------- Event Bindings UI --------------
    on($('#new-task-btn'),'click',()=> openTaskModal());
    on($('#taskModalClose'),'click',()=> modal('#taskModal', false));
    on($('#aboutBtn'),'click',()=>{ populateFeatureList(); modal('#aboutModal', true) });
    on($('#aboutClose'),'click',()=> modal('#aboutModal', false));

    on($('#sidebar-toggle'),'click',()=> $('#sidebar').classList.toggle('collapsed'));
    on($('#dark-toggle'),'click',toggleDark);
    on($('#cmd-palette-btn'),'click',openPalette);

    on($('#exportBtn'),'click',exportJSON);
    on($('#importBtn'),'click',importJSON);
    on($('#csvBtn'),'click',exportCSV);
    on($('#clearBtn'),'click',clearAll);

    on($('#searchInput'),'input',renderBoard);

    // Calendar nav
    on($('#calPrev'),'click',()=>{ const c=state.calendar; c.month--; if(c.month<0){ c.month=11; c.year--; } renderCalendar(); });
    on($('#calNext'),'click',()=>{ const c=state.calendar; c.month++; if(c.month>11){ c.month=0; c.year++; } renderCalendar(); });

    // Music controls
    on($('#musicPlay'),'click',togglePlay);
    on($('#musicPrev'),'click',()=> playMusic(state.music.idx-1));
    on($('#musicNext'),'click',()=> playMusic(state.music.idx+1));
    on($('#musicMute'),'click',muteMusic);
    on(audio,'ended',()=> playMusic(state.music.idx+1));

    // Pomodoro controls
    on($('#pomoStart'),'click',startPomo);
    on($('#pomoPause'),'click',pausePomo);
    on($('#pomoReset'),'click',resetPomo);

    // Focus Mode buttons
    on($('#focusQuit'),'click',()=> leaveFocus(false));
    on($('#focusDone'),'click',()=> leaveFocus(true));

    // Quick actions
    $$('.quick-action-btn').forEach(btn=> on(btn,'click',()=>{
      const act=btn.dataset.action; if(act==='quick:add') openTaskModal(); if(act==='quick:focus') enterFocusQuick();
    }));

    // Form submit
    on($('#taskForm'),'submit',e=>{
      e.preventDefault();
      const id = $('#taskId').value || uid();
      const title = $('#taskTitle').value.trim().replace(/\s+/g,' ').replace(/^\w/, c=>c.toUpperCase());
      const desc = $('#taskDesc').value.trim();
      const priority = $('#taskPriority').value;
      const due = $('#taskDue').value || null;
      const tags = $('#taskTags').value.split(',').map(s=>s.trim()).filter(Boolean);
      const assignee = $('#taskAssignee').value.trim();
      const base = { id, title, desc, priority, due, tags, assignee, progress: 0, status: 'todo', created: Date.now() };
      const exist = state.tasks.find(t=>t.id===id);
      if (exist) { updateTask(id, base); toast('Task diperbarui','success'); } else { addTask(base); toast('Task ditambahkan','success'); }
      modal('#taskModal', false);
      badgeFavicon(); checkAchievements();
    });

    // Delete btn in modal
    on($('#taskDelete'),'click',()=>{ const id=$('#taskId').value; if(id){ removeTask(id); modal('#taskModal', false); }});

    // Board interactions (delegate)
    on($('#board'),'click',e=>{
      const card = e.target.closest('.task-card'); if(!card) return; const id=card.dataset.id; const actBtn = e.target.closest('[data-act]');
      if (actBtn){ const act=actBtn.dataset.act; if(act==='edit') openTaskModal(state.tasks.find(t=>t.id===id)); if(act==='play') enterFocus(id); if(act==='more'){ const t=state.tasks.find(t=>t.id===id); const choice = prompt('Aksi: done, todo, doing, delete, +10% progress'); if(!choice) return; if(choice==='delete') removeTask(id); else if(choice.includes('%')){ const n=(t.progress||0)+10; updateTask(id,{progress: clamp(n,0,100)});} else { updateTask(id,{ status: choice }); } }}
    });

    // Drag keyboard helpers (Feature #98-#99)
    on(document,'keydown',e=>{
      if (e.altKey && ['ArrowLeft','ArrowRight'].includes(e.key)){
        const focus = $('.task-card:focus-within'); if(!focus) return; const id=focus.dataset.id; const t=state.tasks.find(x=>x.id===id); if(!t) return; const delta=e.key==='ArrowRight'?10:-10; updateTask(id,{ progress: clamp((t.progress||0)+delta,0,100) });
      }
      if (e.ctrlKey && ['ArrowLeft','ArrowRight'].includes(e.key)){
        const focus = $('.task-card:focus-within'); if(!focus) return; const id=focus.dataset.id; const t=state.tasks.find(x=>x.id===id); if(!t) return; const cols=['todo','doing','done']; let i=cols.indexOf(t.status); i += (e.key==='ArrowRight'?1:-1); i=clamp(i,0,2); updateTask(id,{ status: cols[i] });
      }
    })

    // Click edit by double
    on($('#board'),'dblclick',e=>{ const card=e.target.closest('.task-card'); if(card) openTaskModal(state.tasks.find(t=>t.id===card.dataset.id)); });

    // User name editable
    on($('#userProfile'),'dblclick',()=>{ const name = prompt('Nama Anda', $('#userName').textContent); if(name){ $('#userName').textContent=name; $('#userAvatar').textContent = name.split(' ').map(p=>p[0]).join('').slice(0,2).toUpperCase(); }});

    // Init ---------
    load();
    if (state.settings.dark) document.documentElement.classList.add('dark-mode');
    renderAll();
    badgeFavicon();
    // preload some demo tasks if empty
    if (!state.tasks.length){
      addTask({ id: uid(), title: 'Set up LP SIS4D', desc: 'Deploy AMP + schema', priority: 'high', status:'todo', tags:['work','urgent'], progress: 20, due: today(), assignee:'@Canva', created: Date.now() });
      addTask({ id: uid(), title: 'Buat banner NENG4D', desc: 'Tema neon hijau', priority: 'medium', status:'doing', tags:['work'], progress: 60, assignee:'@Bagus', created: Date.now() });
      addTask({ id: uid(), title: 'Indexing GSC', desc: 'Fetch & Render', priority: 'low', status:'done', tags:['study'], progress: 100, created: Date.now() });
    }

    // Ask notifications once
    setTimeout(()=>{ if (!state.settings.notifications) enableNotify(); }, 800);

    // Expose minimal API (debug)
    window.UTMP = { state, addTask, updateTask, removeTask, exportJSON, importJSON, exportCSV, undo, redo };

    // Populate feature modal lazy
    on(document,'keydown',e=>{ if(e.key==='?' && e.shiftKey){ populateFeatureList(); modal('#aboutModal', true); }});

  })();
  </script>
</body>
</html>
